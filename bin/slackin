#!/usr/bin/env node

let pkg = require('./../package')
let args = require('args')
let slackin = require('./../dist').default
let hostenv = require('hostenv')

args
  .option(['p', 'port'], 'Port to listen on [$SLACKIN_PORT or 3000]', process.env.SLACKIN_PORT || 3000)
  .option(['h', 'hostname'], 'Hostname to listen on [$SLACKIN_HOSTNAME or 0.0.0.0]', process.env.SLACKIN_HOSTNAME || '0.0.0.0')
  .option(['c', 'channels'], 'One or more comma-separated channel names to allow single-channel guests [$SLACKIN_CHANNELS]', process.env.SLACKIN_CHANNELS)
  .option(['i', 'interval'], 'How frequently (ms) to poll Slack [$SLACKIN_INTERVAL or 30000]', process.env.SLACKIN_INTERVAL || 30000)
  .option(['P', 'path'], 'Path to serve slackin under', '/')
  .option(['s', 'silent'], 'Do not print out warns or errors')
  .option(['x', 'cors'], 'Enable CORS for all routes')
  .option(['C', 'coc'], 'Full URL to a CoC that needs to be agreed to')
  .option(['S', 'css'], 'Full URL to a custom CSS file to use on the main page')
  .option(['?', 'help'], 'Show the usage information')

let flags = args.parse(process.argv, {
  value: '<team-id> <api-token> <google-captcha-secret> <google-captcha-sitekey>',
  help: false,
})

let org = args.sub[0] || process.env.SLACK_SUBDOMAIN
let token = args.sub[1] || process.env.SLACK_API_TOKEN
let emails = process.env.EMAIL_SLACK_LIST || ''

let gcaptcha_secret = args.sub[2] || process.env.GOOGLE_CAPTCHA_SECRET
let gcaptcha_sitekey = args.sub[3] || process.env.GOOGLE_CAPTCHA_SITEKEY

if (flags.help) {
  args.showHelp()
}

if (!org || !token || !gcaptcha_sitekey || !gcaptcha_secret) {
  args.showHelp()
} else {
  flags.org = org
  flags.token = token
  flags.emails = emails
  flags.gcaptcha_secret = gcaptcha_secret
  flags.gcaptcha_sitekey = gcaptcha_sitekey
}

let port = flags.port
let hostname = flags.hostname

slackin(flags).listen(port, hostname, function (err) {
  if (err) throw err
  if (!flags.silent) console.log('%s â€“ listening on %s:%d', new Date, hostname, port)
})
